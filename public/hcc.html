<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hosted Card Capture</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 20px;
      max-width: 400px;
      margin: 0 auto;
      background: #f8f9fa;
      min-height: 100vh;
    }
    .container {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: #374151;
      font-size: 14px;
    }
    input[type="text"],
    input[type="password"] {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
      box-sizing: border-box;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    input:focus {
      outline: none;
      border-color: #0075FF;
      box-shadow: 0 0 0 3px rgba(0, 117, 255, 0.1);
    }
    input.error {
      border-color: #ef4444;
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
    }
    .error-message {
      color: #ef4444;
      font-size: 12px;
      margin-top: 4px;
      display: none;
    }
    .card-type-icon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      width: 24px;
      height: 16px;
      opacity: 0.8;
      font-size: 18px;
    }
    .input-container {
      position: relative;
    }
    button[type="submit"] {
      background: linear-gradient(135deg, #0075FF 0%, #0056CC 100%);
      color: white;
      border: none;
      padding: 14px 24px;
      font-size: 16px;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      width: 100%;
      transition: transform 0.1s, box-shadow 0.1s;
    }
    button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(0, 117, 255, 0.3);
    }
    button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .security-notice {
      margin-top: 24px;
      padding: 16px;
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      border: 1px solid #bae6fd;
      border-radius: 8px;
      font-size: 13px;
      color: #0369a1;
      line-height: 1.5;
    }
    .security-notice svg {
      width: 20px;
      height: 20px;
      margin-right: 12px;
      vertical-align: middle;
      flex-shrink: 0;
    }
    .security-notice-content {
      display: flex;
      align-items: flex-start;
    }
    .success-message {
      display: none;
      padding: 12px;
      background: #d1fae5;
      border: 1px solid #a7f3d0;
      border-radius: 6px;
      color: #065f46;
      font-size: 14px;
      margin-top: 16px;
    }
  </style>
</head>
<body>
  <div class="container">
    <form id="cardForm">
      <div class="form-group">
        <label for="cardNumber">Card Number</label>
        <div class="input-container">
          <input type="text" id="cardNumber" name="cardNumber" maxlength="23" placeholder="1234 5678 9012 3456" inputmode="numeric" aria-describedby="cardNumberError" />
          <div id="cardTypeIcon" class="card-type-icon" aria-hidden="true"></div>
        </div>
        <div id="cardNumberError" class="error-message" role="alert">Please enter a valid card number</div>
      </div>

      <div class="form-group">
        <label for="expiry">Expiry Date (MM/YY)</label>
        <input type="text" id="expiry" name="expiry" maxlength="5" placeholder="MM/YY" inputmode="numeric" aria-describedby="expiryError" />
        <div id="expiryError" class="error-message" role="alert">Please enter a valid expiry date</div>
      </div>

      <div class="form-group">
        <label for="cvv">CVV</label>
        <input type="password" id="cvv" name="cvv" maxlength="4" inputmode="numeric" placeholder="â€¢â€¢â€¢" aria-describedby="cvvError" />
        <div id="cvvError" class="error-message" role="alert">Please enter a valid CVV</div>
      </div>

      <button type="submit" id="submitBtn">Add Card Securely</button>

      <div id="successMessage" class="success-message" role="alert">
        Card added successfully! Processing payment...
      </div>
    </form>

    <div class="security-notice">
      <div class="security-notice-content">
        <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
          <path d="M12 2L3 7v10c0 5.55 3.84 9.74 9 11 5.16-1.26 9-5.45 9-11V7l-9-5z"/>
          <path d="M10 17l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
        </svg>
        <div>
          <strong>Bank-Grade Security</strong><br>
          Your card details are encrypted and processed through our PCI DSS compliant systems. We never store your full card number or CVV.
        </div>
      </div>
    </div>
  </div>

  <script>
    // Form elements
    const cardNumberInput = document.getElementById('cardNumber');
    const expiryInput = document.getElementById('expiry');
    const cvvInput = document.getElementById('cvv');
    const submitBtn = document.getElementById('submitBtn');
    const successMessage = document.getElementById('successMessage');

    // Error elements
    const cardNumberError = document.getElementById('cardNumberError');
    const expiryError = document.getElementById('expiryError');
    const cvvError = document.getElementById('cvvError');

    // Validation state
    let currentCardType = 'unknown';
    let isFormValid = false;

    // Card validation utilities
    function luhnCheck(cardNumber) {
      const digits = cardNumber.replace(/\s/g, '');
      if (!/^\d+$/.test(digits)) return false;

      let sum = 0;
      let shouldDouble = false;

      for (let i = digits.length - 1; i >= 0; i--) {
        let digit = parseInt(digits.charAt(i), 10);

        if (shouldDouble) {
          digit *= 2;
          if (digit > 9) digit -= 9;
        }

        sum += digit;
        shouldDouble = !shouldDouble;
      }

      return sum % 10 === 0;
    }

    function getCardType(cardNumber) {
      const number = cardNumber.replace(/\s/g, '');
      if (/^4/.test(number)) return 'visa';
      if (/^5[1-5]/.test(number) || /^2[2-7]/.test(number)) return 'mastercard';
      if (/^3[47]/.test(number)) return 'amex';
      if (/^6(?:011|5)/.test(number)) return 'discover';
      if (/^35/.test(number)) return 'jcb';
      if (/^30[0-5]/.test(number) || /^36/.test(number) || /^38/.test(number)) return 'diners';
      return 'unknown';
    }

    function getExpectedCVVLength(cardType) {
      return cardType === 'amex' ? 4 : 3;
    }

    function formatCardNumber(value) {
      const digits = value.replace(/\D/g, '');
      const groups = digits.match(/(\d{1,4})/g) || [];
      return groups.join(' ').substring(0, 23);
    }

    function updateCardTypeIcon(cardType) {
      const iconElement = document.getElementById('cardTypeIcon');
      const icons = {
        visa: 'ðŸ’³',
        mastercard: 'ðŸ’³',
        amex: 'ðŸ’³',
        discover: 'ðŸ’³',
        jcb: 'ðŸ’³',
        diners: 'ðŸ’³'
      };
      iconElement.textContent = icons[cardType] || '';
    }

    function showError(element, message) {
      element.textContent = message;
      element.style.display = 'block';
      element.previousElementSibling.classList.add('error');
    }

    function hideError(element) {
      element.style.display = 'none';
      element.previousElementSibling.classList.remove('error');
    }

    function validateCardNumber() {
      const value = cardNumberInput.value.replace(/\s/g, '');
      const digitsOnly = value.replace(/\D/g, '');

      if (digitsOnly.length === 0) {
        hideError(cardNumberError);
        currentCardType = 'unknown';
        updateCardTypeIcon(currentCardType);
        return true;
      }

      if (digitsOnly.length < 13 || digitsOnly.length > 19) {
        showError(cardNumberError, 'Card number must be 13-19 digits');
        currentCardType = 'unknown';
        updateCardTypeIcon(currentCardType);
        return false;
      }

      if (!luhnCheck(digitsOnly)) {
        showError(cardNumberError, 'Please enter a valid card number');
        currentCardType = 'unknown';
        updateCardTypeIcon(currentCardType);
        return false;
      }

      currentCardType = getCardType(digitsOnly);
      if (currentCardType === 'unknown') {
        showError(cardNumberError, 'Unsupported card type. Please use Visa, Mastercard, American Express, or Discover');
        updateCardTypeIcon(currentCardType);
        return false;
      }

      updateCardTypeIcon(currentCardType);
      hideError(cardNumberError);
      return true;
    }

    function validateExpiry() {
      const value = expiryInput.value.trim();

      if (value.length === 0) {
        hideError(expiryError);
        return true;
      }

      const pattern = /^(0[1-9]|1[0-2])\/[0-9]{2}$/;
      if (!pattern.test(value)) {
        showError(expiryError, 'Please enter expiry date in MM/YY format');
        return false;
      }

      const [month, year] = value.split('/');
      const currentDate = new Date();
      const currentYear = currentDate.getFullYear() % 100;
      const currentMonth = currentDate.getMonth() + 1;
      const expMonth = parseInt(month, 10);
      const expYear = parseInt(year, 10);

      if (expYear < currentYear || (expYear === currentYear && expMonth < currentMonth)) {
        showError(expiryError, 'Card has expired');
        return false;
      }

      hideError(expiryError);
      return true;
    }

    function validateCVV() {
      const value = cvvInput.value.trim();

      if (value.length === 0) {
        hideError(cvvError);
        return true;
      }

      const expectedLength = getExpectedCVVLength(currentCardType);
      if (value.length !== expectedLength) {
        showError(cvvError, `CVV must be ${expectedLength} digits for this card type`);
        return false;
      }

      hideError(cvvError);
      return true;
    }

    function validateForm() {
      const isCardValid = validateCardNumber();
      const isExpiryValid = validateExpiry();
      const isCVVValid = validateCVV();

      isFormValid = isCardValid && isExpiryValid && isCVVValid && cardNumberInput.value.trim() && expiryInput.value.trim() && cvvInput.value.trim();
      submitBtn.disabled = !isFormValid;
      return isFormValid;
    }

    // Event listeners
    cardNumberInput.addEventListener('input', (e) => {
      const start = e.target.selectionStart;
      const end = e.target.selectionEnd;
      const oldValue = e.target.value;

      e.target.value = formatCardNumber(e.target.value);

      // Preserve cursor position
      const newLength = e.target.value.length;
      const oldLength = oldValue.length;
      const diff = newLength - oldLength;

      if (diff > 0) {
        e.target.setSelectionRange(start + diff, end + diff);
      } else {
        e.target.setSelectionRange(Math.max(start + diff, 0), Math.max(end + diff, 0));
      }

      validateForm();
    });

    cardNumberInput.addEventListener('blur', validateCardNumber);

    expiryInput.addEventListener('input', (e) => {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length >= 2) {
        const month = value.slice(0, 2);
        const year = value.slice(2, 4);
        if (parseInt(month, 10) > 12) {
          value = '12' + year;
        }
        value = month + (year ? '/' + year : '');
      }
      e.target.value = value.slice(0, 5);
      validateForm();
    });

    expiryInput.addEventListener('blur', validateExpiry);

    cvvInput.addEventListener('input', (e) => {
      const value = e.target.value.replace(/\D/g, '');
      const expectedLength = getExpectedCVVLength(currentCardType);
      e.target.value = value.slice(0, expectedLength);
      validateForm();
    });

    cvvInput.addEventListener('blur', validateCVV);

    // Form submission
    document.getElementById('cardForm').addEventListener('submit', (e) => {
      e.preventDefault();

      if (!validateForm()) {
        return;
      }

      // Show success message and disable form
      successMessage.style.display = 'block';
      submitBtn.disabled = true;
      submitBtn.textContent = 'Processing...';

      const cardData = {
        cardNumber: cardNumberInput.value.replace(/\s/g, ''),
        expiry: expiryInput.value,
        cvv: cvvInput.value,
        cardType: currentCardType
      };

      // Send data to parent window
      window.parent.postMessage({
        type: 'cardData',
        data: cardData
      }, '*');
    });

    // Initial validation
    validateForm();
  </script>
</body>
</html>
